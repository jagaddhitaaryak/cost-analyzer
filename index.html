<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Logistics Planner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0A1A2F', 
                        accent: '#D4AF37',  
                        bg: '#F5F6FA',      
                        success: '#10B981', 
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F5F6FA; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Input Number Clean */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Rank Badges */
        .rank-badge { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 14px; }
        .rank-1 { background-color: #FFFBEB; color: #D97706; border: 2px solid #FCD34D; } 
        .rank-2 { background-color: #F1F5F9; color: #64748B; border: 2px solid #CBD5E1; } 
        .rank-3 { background-color: #FFF7ED; color: #C2410C; border: 2px solid #FDBA74; } 

        /* Tab Active State */
        .tab-btn.active { background-color: #0A1A2F; color: #D4AF37; border-color: #0A1A2F; }
        
        /* Modal Animation */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800">

    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-chess-queen text-accent text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">Strategic<span class="text-accent">Logistics</span></h1>
            </div>
            <div class="text-sm text-gray-300 hidden md:block">
                <i class="fa-solid fa-database mr-1"></i> Data Management
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1">
            <div id="formContainer" class="bg-white rounded-xl shadow-md p-6 sticky top-24 border-t-4 border-accent transition-all duration-300">
                
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-bold text-primary" id="formTitle">Input Data</h2>
                            <span id="editBadge" class="hidden bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase">Edit Mode</span>
                        </div>
                        <p class="text-sm text-gray-500" id="formDesc">Manual atau Import Excel.</p>
                    </div>
                    
                    <div>
                        <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden" onchange="handleExcelUpload(this)">
                        <button onclick="document.getElementById('excelFile').click()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-3 rounded shadow flex items-center gap-1 transition">
                            <i class="fa-solid fa-file-csv"></i> Import
                        </button>
                        <button onclick="downloadTemplate()" class="text-[10px] text-gray-400 underline mt-1 hover:text-primary block text-right w-full">
                            Template
                        </button>
                    </div>
                </div>

                <form id="costForm" class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Kurs USD</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400 font-bold">Rp</span>
                            <input type="text" id="exchangeRate" required value="16.500" onkeyup="formatNumberInput(this)"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition font-semibold text-primary">
                        </div>
                    </div>

                    <hr class="border-dashed border-gray-200">

                    <div>
                        <label class="block text-sm font-medium text-primary mb-1">Nama Angkutan (Vendor)</label>
                        <input type="text" id="transporterName" placeholder="Contoh: PT. SPIL" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-primary mb-1">Nama Customer</label>
                        <input type="text" id="customerName" placeholder="Contoh: KKM" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-primary mb-1">Zona Pengiriman</label>
                        <select id="zoneSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition bg-white cursor-pointer">
                            <option value="INTERISLAND">INTERISLAND</option>
                            <option value="JATENG">JATENG</option>
                            <option value="JATIM">JATIM</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-primary mb-1">Tujuan</label>
                        <input type="text" id="destination" placeholder="Contoh: SEMARANG" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-primary mb-1">Harga Total (IDR)</label>
                            <input type="text" id="totalPrice" placeholder="0" required onkeyup="formatNumberInput(this)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-primary mb-1">Kapasitas (KG)</label>
                            <input type="text" id="capacity" placeholder="0" required onkeyup="formatNumberInput(this)"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                            <p class="text-[10px] text-gray-400 mt-1 text-right">*Input dalam Kilogram</p>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <button type="button" id="cancelEditBtn" onclick="cancelEdit()" 
                            class="hidden w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition duration-300">
                            Batal
                        </button>
                        <button type="submit" id="submitBtn"
                            class="w-full bg-primary hover:bg-opacity-90 text-white font-bold py-3 rounded-lg shadow-lg transform hover:-translate-y-1 transition duration-300 flex justify-center items-center gap-2">
                            <i class="fa-solid fa-calculator text-accent"></i> <span>Hitung & Simpan</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2 flex flex-col gap-6">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in mb-2">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-orange-500 h-full">
                    <div class="bg-orange-50 p-4 border-b border-orange-100 flex justify-between items-center">
                        <h3 class="font-bold text-orange-800 text-lg uppercase tracking-wide">Top Jateng (Avg Cost)</h3>
                        <i class="fa-solid fa-map-location-dot text-orange-400 text-xl"></i>
                    </div>
                    <div id="leaderboard-JATENG" class="p-3 min-h-[220px] max-h-[350px] overflow-y-auto custom-scrollbar">
                        <div class="text-sm text-center text-gray-400 py-10">Menunggu data...</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-purple-500 h-full">
                    <div class="bg-purple-50 p-4 border-b border-purple-100 flex justify-between items-center">
                        <h3 class="font-bold text-purple-800 text-lg uppercase tracking-wide">Top Jatim (Avg Cost)</h3>
                        <i class="fa-solid fa-map-location-dot text-purple-400 text-xl"></i>
                    </div>
                    <div id="leaderboard-JATIM" class="p-3 min-h-[220px] max-h-[350px] overflow-y-auto custom-scrollbar">
                        <div class="text-sm text-center text-gray-400 py-10">Menunggu data...</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-blue-500 h-full">
                    <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                        <h3 class="font-bold text-blue-800 text-lg uppercase tracking-wide">Top Medan (Avg Cost)</h3>
                        <i class="fa-solid fa-ship text-blue-400 text-xl"></i>
                    </div>
                    <div id="leaderboard-MEDAN" class="p-3 min-h-[220px] max-h-[350px] overflow-y-auto custom-scrollbar">
                        <div class="text-sm text-center text-gray-400 py-10">Menunggu data...</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden border-t-4 border-teal-500 h-full">
                    <div class="bg-teal-50 p-4 border-b border-teal-100 flex justify-between items-center">
                        <h3 class="font-bold text-teal-800 text-lg uppercase tracking-wide">Top Batam (Avg Cost)</h3>
                        <i class="fa-solid fa-anchor text-teal-400 text-xl"></i>
                    </div>
                    <div id="leaderboard-BATAM" class="p-3 min-h-[220px] max-h-[350px] overflow-y-auto custom-scrollbar">
                        <div class="text-sm text-center text-gray-400 py-10">Menunggu data...</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col min-h-[600px]">
                
                <div class="p-6 border-b border-gray-200 bg-white flex flex-col gap-6">
                    
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-primary tracking-tight">Ranking Data</h2>
                            <p class="text-sm text-gray-500 mt-1">Analisa biaya per ton termurah (Sort by Lowest).</p>
                        </div>
                        <div class="flex gap-3 items-center mt-3 md:mt-0">
                            <button onclick="clearAllData()" class="bg-red-50 text-red-600 hover:bg-red-600 hover:text-white text-xs font-bold px-4 py-2 rounded-lg border border-red-200 transition-colors flex items-center gap-2">
                                <i class="fa-solid fa-trash-can"></i> Hapus Semua
                            </button>
                            <div class="bg-green-100 text-green-800 text-xs px-4 py-2 rounded-lg font-bold border border-green-200 flex items-center gap-2">
                                <span class="relative flex h-2 w-2">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                                </span>
                                Live Sync
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="md:col-span-5 relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></span>
                            <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari vendor, customer, tujuan..." 
                                spellcheck="false"
                                class="w-full h-10 pl-10 pr-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition shadow-sm">
                        </div>
                        <div class="md:col-span-3">
                            <select id="filterCustomer" class="h-10 w-full px-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary bg-white font-semibold text-primary shadow-sm cursor-pointer">
                                <option value="ALL">Semua Customer</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <select id="filterDest" class="h-10 w-full px-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:border-primary bg-white shadow-sm cursor-pointer">
                                <option value="ALL">Semua Tujuan</option>
                            </select>
                        </div>
                        <div class="md:col-span-1 text-right">
                            <button onclick="resetFilters()" class="h-10 w-full bg-white border border-gray-300 text-gray-500 rounded-lg text-sm hover:bg-gray-100 hover:text-primary transition shadow-sm flex items-center justify-center" title="Reset Filter">
                                <i class="fa-solid fa-rotate-left"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest pl-1">Filter Zona Wilayah</span>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setZone('ALL')" id="tab-ALL" class="tab-btn active px-5 py-2 rounded-full text-xs font-bold border border-gray-300 text-gray-600 hover:bg-gray-100 transition-all flex-grow md:flex-grow-0 text-center shadow-sm">SEMUA</button>
                            <button onclick="setZone('JATENG')" id="tab-JATENG" class="tab-btn px-5 py-2 rounded-full text-xs font-bold border border-gray-300 text-gray-600 hover:bg-gray-100 transition-all flex-grow md:flex-grow-0 text-center shadow-sm">JATENG</button>
                            <button onclick="setZone('JATIM')" id="tab-JATIM" class="tab-btn px-5 py-2 rounded-full text-xs font-bold border border-gray-300 text-gray-600 hover:bg-gray-100 transition-all flex-grow md:flex-grow-0 text-center shadow-sm">JATIM</button>
                            <button onclick="setZone('MEDAN')" id="tab-MEDAN" class="tab-btn px-5 py-2 rounded-full text-xs font-bold border border-gray-300 text-gray-600 hover:bg-gray-100 transition-all flex-grow md:flex-grow-0 text-center shadow-sm">MEDAN</button>
                            <button onclick="setZone('BATAM')" id="tab-BATAM" class="tab-btn px-5 py-2 rounded-full text-xs font-bold border border-gray-300 text-gray-600 hover:bg-gray-100 transition-all flex-grow md:flex-grow-0 text-center shadow-sm">BATAM</button>
                        </div>
                    </div>

                </div>

                <div class="overflow-hidden table-container flex-grow">
                    <table class="w-full text-left border-collapse table-fixed">
                        <thead class="bg-primary text-white text-xs uppercase tracking-wider sticky top-0 z-10">
                            <tr>
                                <th class="p-4 font-semibold text-center w-[5%]">#</th>
                                <th class="p-4 font-semibold w-[30%]">Detail Angkutan</th>
                                <th class="p-4 font-semibold text-right w-[15%]">Kapasitas</th>
                                <th class="p-4 font-semibold text-right w-[20%]">Total (IDR)</th>
                                <th class="p-4 font-semibold text-right w-[20%] bg-gray-900 border-l border-gray-700">Cost / Ton Analysis</th>
                                <th class="p-4 text-center w-[10%]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-sm divide-y divide-gray-100">
                            <tr><td colspan="6" class="p-10 text-center text-gray-400">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div id="customModal" class="hidden fixed inset-0 bg-primary bg-opacity-70 z-[999] flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-96 max-w-[90%] transform transition-all scale-100 overflow-hidden">
            <div id="modalHeader" class="bg-primary p-4 flex justify-between items-center">
                <h3 id="modalTitle" class="text-white font-bold text-lg tracking-wide"><i class="fa-solid fa-bell mr-2"></i>Notifikasi</h3>
                <button onclick="closeModal()" class="text-gray-300 hover:text-white transition"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 text-center">
                <div id="modalIcon" class="mb-4 text-4xl"></div>
                <p id="modalMessage" class="text-gray-700 font-medium text-lg leading-relaxed"></p>
            </div>
            <div id="modalFooter" class="bg-gray-50 p-4 flex justify-center gap-3 border-t border-gray-100"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, getDocs, doc, onSnapshot, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCzOa5jMieOa9STmmITL9TOn71EWKHodL8",
            authDomain: "cost-logistic.firebaseapp.com",
            projectId: "cost-logistic",
            storageBucket: "cost-logistic.firebasestorage.app",
            messagingSenderId: "331790291688",
            appId: "1:331790291688:web:db43ce660994556ee4af5d",
            measurementId: "G-56FXKMYFZV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, 'logistics_costs');

        window.allDocs = []; 
        window.currentZone = 'ALL';
        window.editModeId = null;
        let confirmResolve = null;

        // --- MODAL ---
        window.closeModal = function() {
            document.getElementById('customModal').classList.add('hidden');
            if (confirmResolve) { confirmResolve(false); confirmResolve = null; }
        }

        function showNotification(title, message, type = 'success') {
            const modal = document.getElementById('customModal');
            const mHeader = document.getElementById('modalHeader');
            const mIcon = document.getElementById('modalIcon');
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalMessage').innerText = message;
            if(type === 'success') { mHeader.className = "bg-green-600 p-4 flex justify-between items-center"; mIcon.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>'; } 
            else if (type === 'error') { mHeader.className = "bg-red-600 p-4 flex justify-between items-center"; mIcon.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500"></i>'; } 
            else { mHeader.className = "bg-primary p-4 flex justify-between items-center"; mIcon.innerHTML = '<i class="fa-solid fa-circle-info text-primary"></i>'; }
            document.getElementById('modalFooter').innerHTML = `<button onclick="closeModal()" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-6 rounded-lg shadow transition">OK</button>`;
            modal.classList.remove('hidden');
        }

        function askConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalMessage').innerText = message;
                document.getElementById('modalHeader').className = "bg-accent p-4 flex justify-between items-center";
                document.getElementById('modalIcon').innerHTML = '<i class="fa-solid fa-circle-question text-accent"></i>';
                document.getElementById('modalFooter').innerHTML = `<button id="btnCancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition">Batal</button><button id="btnConfirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition">Ya, Lanjutkan</button>`;
                modal.classList.remove('hidden');
                document.getElementById('btnConfirm').onclick = () => { document.getElementById('customModal').classList.add('hidden'); resolve(true); };
                document.getElementById('btnCancel').onclick = () => { document.getElementById('customModal').classList.add('hidden'); resolve(false); };
            });
        }

        // --- FILTER DINAMIS ---
        function initDropdowns() {
            const custSelect = document.getElementById('filterCustomer');
            const currentCust = custSelect.value;
            const customers = [...new Set(window.allDocs.map(d => d.customerName).filter(Boolean))].sort();
            let html = `<option value="ALL">Semua Customer</option>`;
            customers.forEach(c => { html += `<option value="${c}">${c}</option>`; });
            custSelect.innerHTML = html;
            if(customers.includes(currentCust)) { custSelect.value = currentCust; }
            updateDestDropdown();
        }

        function updateDestDropdown() {
            const custSelect = document.getElementById('filterCustomer');
            const destSelect = document.getElementById('filterDest');
            const selectedCust = custSelect.value;
            const currentDest = destSelect.value;
            let relevantDocs = window.allDocs;
            if (selectedCust !== 'ALL') { relevantDocs = window.allDocs.filter(d => d.customerName === selectedCust); }
            const dests = [...new Set(relevantDocs.map(d => d.destination).filter(Boolean))].sort();
            let html = `<option value="ALL">Semua Tujuan</option>`;
            dests.forEach(d => { html += `<option value="${d}">${d}</option>`; });
            destSelect.innerHTML = html;
            if (dests.includes(currentDest)) { destSelect.value = currentDest; } else { destSelect.value = 'ALL'; }
        }

        window.handleCustomerChange = function() { updateDestDropdown(); renderTable(); }

        // --- NORMALISASI ZONA ---
        function normalizeZone(inputZone) {
            if(!inputZone) return 'INTERISLAND'; 
            const z = inputZone.toUpperCase().trim();
            if(z.includes('JATENG') || z.includes('JAWA TENGAH') || z.includes('CENTRAL JAVA') || z.includes('SMG') || z.includes('SEMARANG')) return 'JATENG';
            if(z.includes('JATIM') || z.includes('JAWA TIMUR') || z.includes('SBY') || z.includes('SURABAYA')) return 'JATIM';
            if(z.includes('INTER') || z.includes('MEDAN') || z.includes('BATAM')) return 'INTERISLAND';
            return z;
        }

        function getZoneColor(zoneRaw) {
            const z = normalizeZone(zoneRaw);
            if(z === 'INTERISLAND') return "bg-blue-100 text-blue-800 border border-blue-200";
            if(z === 'JATENG') return "bg-orange-100 text-orange-800 border border-orange-200";
            if(z === 'JATIM') return "bg-purple-100 text-purple-800 border border-purple-200";
            return "bg-gray-100 text-gray-600 border border-gray-200";
        }

        // --- EXPOSED FUNCTIONS ---
        window.setZone = function(zone) {
            window.currentZone = zone;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${zone}`).classList.add('active');
            renderTable();
        };
        
        window.resetFilters = function() {
            document.getElementById('filterCustomer').value = 'ALL';
            document.getElementById('searchInput').value = ''; 
            updateDestDropdown();
            document.getElementById('filterDest').value = 'ALL';
            window.setZone('ALL');
        }

        window.formatNumberInput = function(input) {
            let value = input.value.replace(/\D/g, ""); 
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            input.value = value;
        }

        window.clearAllData = async function() {
            const confirm1 = await askConfirm("Hapus Semua Data?", "Tindakan ini akan menghapus SELURUH data.");
            if(confirm1) {
                const confirm2 = await askConfirm("Konfirmasi Terakhir", "Yakin? Data hilang permanen.");
                if(confirm2) {
                    try {
                        const querySnapshot = await getDocs(colRef);
                        const deletePromises = [];
                        querySnapshot.forEach((doc) => deletePromises.push(deleteDoc(doc.ref)));
                        await Promise.all(deletePromises);
                        showNotification("Berhasil", "Database dikosongkan.", "success");
                    } catch (error) { showNotification("Gagal", error.message, "error"); }
                }
            }
        }

        // --- EXCEL ---
        window.downloadTemplate = function() {
            const data = [{ "VENDOR": "PT. CONTOH", "CUSTOMER": "KKM", "ZONA": "JATENG", "TUJUAN": "SEMARANG", "HARGA": 12500000, "KAPASITAS": 25000 }];
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Template");
            XLSX.writeFile(wb, "Template_Logistik.xlsx");
        }

        window.handleExcelUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if(jsonData.length === 0) { showNotification("Info", "Excel kosong.", "error"); return; }
                    let rate = parseFormattedNumber(document.getElementById('exchangeRate').value) || 16500; 
                    let count = 0;
                    for (const row of jsonData) {
                        const vendor = row['VENDOR'] || row['vendor'] || '-';
                        const cust = row['CUSTOMER'] || row['customer'] || '-';
                        const zone = normalizeZone(row['ZONA'] || row['zona']);
                        const dest = row['TUJUAN'] || row['tujuan'] || '-';
                        const price = parseFloat(row['HARGA'] || row['harga'] || 0);
                        const capKG = parseFloat(row['KAPASITAS'] || row['kapasitas'] || 0);
                        if(price > 0 && capKG > 0) {
                            const capTon = capKG / 1000;
                            const costIdr = price / capTon;
                            const costUsd = costIdr / rate;
                            await addDoc(colRef, { transporterName: vendor, customerName: cust, zone: zone, destination: dest, totalPrice: price, capacityKG: capKG, exchangeRate: rate, costPerTonIdr: costIdr, costPerTonUsd: costUsd, createdAt: serverTimestamp() });
                            count++;
                        }
                    }
                    showNotification("Sukses", `Import ${count} data berhasil!`, "success");
                    input.value = ''; 
                } catch (error) { showNotification("Error", "Gagal baca Excel.", "error"); }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- HELPERS ---
        function parseFormattedNumber(str) { if (!str) return 0; return parseFloat(str.replace(/\./g, '')); }
        function formatForInput(num) { return new Intl.NumberFormat('id-ID').format(num); }
        const formatIDR = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        const formatUSD = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(num);
        const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(num);

        // --- CRUD ---
        document.getElementById('costForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('transporterName').value;
            const customer = document.getElementById('customerName').value;
            const zone = document.getElementById('zoneSelect').value;
            const dest = document.getElementById('destination').value;
            const price = parseFormattedNumber(document.getElementById('totalPrice').value);
            const capacityKG = parseFormattedNumber(document.getElementById('capacity').value);
            const rate = parseFormattedNumber(document.getElementById('exchangeRate').value);
            const capacityTon = capacityKG / 1000;
            const costPerTonIdr = price / capacityTon; 
            const costPerTonUsd = costPerTonIdr / rate;
            const payload = { transporterName: name, customerName: customer, zone: zone, destination: dest, totalPrice: price, capacityKG: capacityKG, exchangeRate: rate, costPerTonIdr: costPerTonIdr, costPerTonUsd: costPerTonUsd, updatedAt: serverTimestamp() };
            try {
                if(window.editModeId) { await updateDoc(doc(db, "logistics_costs", window.editModeId), payload); showNotification("Sukses", "Data diupdate!", "success"); cancelEdit(); }
                else { payload.createdAt = serverTimestamp(); await addDoc(colRef, payload); showNotification("Tersimpan", "Data baru disimpan.", "success"); }
                document.getElementById('costForm').reset(); document.getElementById('exchangeRate').value = "16.500";
            } catch (error) { showNotification("Error", error.message, "error"); }
        });

        window.handleEdit = function(id) {
            const data = window.allDocs.find(d => d.id === id);
            if(!data) return;
            document.getElementById('transporterName').value = data.transporterName;
            document.getElementById('customerName').value = data.customerName;
            document.getElementById('zoneSelect').value = normalizeZone(data.zone);
            document.getElementById('destination').value = data.destination;
            document.getElementById('totalPrice').value = formatForInput(data.totalPrice);
            document.getElementById('capacity').value = formatForInput(data.capacityKG);
            document.getElementById('exchangeRate').value = formatForInput(data.exchangeRate);
            window.editModeId = id;
            document.getElementById('formTitle').innerText = "Edit Data";
            document.getElementById('editBadge').classList.remove('hidden');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('submitBtn').classList.add('bg-orange-600', 'w-2/3');
            document.getElementById('submitBtn').classList.remove('w-full');
            document.getElementById('submitBtn').innerHTML = `Update Data`;
            document.getElementById('formContainer').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        window.cancelEdit = function() {
            window.editModeId = null;
            document.getElementById('costForm').reset();
            document.getElementById('formTitle').innerText = "Input Data";
            document.getElementById('editBadge').classList.add('hidden');
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('submitBtn').classList.remove('bg-orange-600', 'w-2/3');
            document.getElementById('submitBtn').classList.add('w-full');
            document.getElementById('submitBtn').innerHTML = `<i class="fa-solid fa-calculator text-accent"></i> <span>Hitung & Simpan</span>`;
            document.getElementById('exchangeRate').value = "16.500";
        }

        window.handleDelete = async function(id) { 
            const confirm = await askConfirm("Hapus Data?", "Yakin menghapus data ini?");
            if(confirm) { try { await deleteDoc(doc(db, "logistics_costs", id)); showNotification("Terhapus", "Data dihapus.", "success"); } catch(e) { showNotification("Error", e.message, "error"); } }
        }

        // --- MAIN RENDER ---
        const q = query(colRef, orderBy("costPerTonIdr", "asc"));
        onSnapshot(q, (snapshot) => {
            window.allDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            initDropdowns();
            renderTable();
            renderAllLeaderboards();
        });

        // 1. GLOBAL EXPOSE FUNCTION FOR HTML ONKEYUP
        window.renderTable = renderTable;

        // 2. ATTACH LISTENERS
        document.getElementById('filterCustomer').onchange = window.handleCustomerChange;
        document.getElementById('filterDest').onchange = renderTable;

        // --- RENDER TABLE (UPDATED SEARCH LOGIC) ---
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            const filterCust = document.getElementById('filterCustomer').value;
            const filterDest = document.getElementById('filterDest').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim(); // Trim for safety

            let filteredDocs = window.allDocs.filter(d => {
                // 1. Logic Tab Zone
                const normZone = normalizeZone(d.zone);
                let matchZone = false;
                if (window.currentZone === 'ALL') matchZone = true;
                else if (window.currentZone === 'MEDAN') matchZone = normZone === 'INTERISLAND' && d.destination.toUpperCase().includes('MEDAN');
                else if (window.currentZone === 'BATAM') matchZone = normZone === 'INTERISLAND' && d.destination.toUpperCase().includes('BATAM');
                else matchZone = normZone === window.currentZone; 

                // 2. Logic Dropdown
                const matchCust = filterCust === 'ALL' || d.customerName === filterCust;
                const matchDest = filterDest === 'ALL' || d.destination === filterDest;

                // 3. Logic Search Global (Check All Fields)
                const searchStr = (
                    (d.transporterName || "") + " " + 
                    (d.customerName || "") + " " + 
                    (d.destination || "") + " " + 
                    (d.zone || "")
                ).toLowerCase();
                
                const matchSearch = !searchQuery || searchStr.includes(searchQuery);

                return matchZone && matchCust && matchDest && matchSearch;
            });

            if (filteredDocs.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400">Tidak ada data sesuai filter.</td></tr>`; return; }

            filteredDocs.forEach((data, index) => {
                const displayCapacity = data.capacityKG ? data.capacityKG : (data.capacity * 1000); 
                const rank = index + 1;
                let rankDisplay = `<span class="font-bold text-gray-500 text-lg">${rank}</span>`;
                let rowClass = "hover:bg-gray-50";
                
                if (rank === 1) { rankDisplay = `<div class="rank-badge rank-1 shadow-sm mx-auto">ðŸ¥‡</div>`; rowClass = "bg-yellow-50/60"; } 
                else if (rank === 2) { rankDisplay = `<div class="rank-badge rank-2 shadow-sm mx-auto">ðŸ¥ˆ</div>`; } 
                else if (rank === 3) { rankDisplay = `<div class="rank-badge rank-3 shadow-sm mx-auto">ðŸ¥‰</div>`; }
                
                const zoneColor = getZoneColor(data.zone);
                const zoneClean = normalizeZone(data.zone);
                const zoneLabel = `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${zoneColor} inline-block mt-1">${zoneClean}</span>`;

                const rowHtml = `
                    <tr class="${rowClass} transition-colors border-b border-gray-100">
                        <td class="p-3 text-center align-middle">${rankDisplay}</td>
                        <td class="p-3 align-middle">
                            <div class="font-bold text-primary text-base leading-tight mb-1 break-words">${data.transporterName}</div>
                            <div class="flex flex-wrap items-center gap-2"><div class="text-xs font-semibold text-gray-500 flex items-center"><i class="fa-solid fa-building mr-1"></i> ${data.customerName || '-'}</div>${zoneLabel}</div>
                            <div class="text-xs text-accent font-semibold mt-1"><i class="fa-solid fa-location-dot mr-1"></i> ${data.destination}</div>
                        </td>
                        <td class="p-3 text-right align-middle"><div class="font-bold text-gray-700 text-sm">${formatNumber(displayCapacity)} KG</div><div class="text-xs text-gray-400">(${(displayCapacity/1000).toFixed(2)} Ton)</div></td>
                        <td class="p-3 text-right align-middle"><div class="font-mono text-gray-600 text-sm">${formatIDR(data.totalPrice)}</div></td>
                        <td class="p-3 text-right align-middle bg-gray-50/50 border-l border-gray-100">
                            <div class="font-bold text-primary text-lg leading-none mb-1">${formatIDR(data.costPerTonIdr)}</div>
                            <div class="font-bold text-green-600 text-lg leading-none">${formatUSD(data.costPerTonUsd)}</div>
                        </td>
                        <td class="p-3 text-center align-middle">
                            <div class="flex justify-center gap-2">
                                <button class="bg-white border border-gray-200 text-gray-500 hover:text-orange-600 hover:border-orange-300 transition p-2 rounded-lg shadow-sm" onclick="handleEdit('${data.id}')" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                                <button class="bg-white border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-300 transition p-2 rounded-lg shadow-sm" onclick="handleDelete('${data.id}')" title="Hapus"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </td>
                    </tr>`;
                tableBody.innerHTML += rowHtml;
            });
        }

        function renderAllLeaderboards() {
            renderGenericCard('leaderboard-JATENG', 'text-orange-600', d => normalizeZone(d.zone) === 'JATENG');
            renderGenericCard('leaderboard-JATIM', 'text-purple-600', d => normalizeZone(d.zone) === 'JATIM');
            renderGenericCard('leaderboard-MEDAN', 'text-blue-600', d => normalizeZone(d.zone) === 'INTERISLAND' && d.destination.toUpperCase().includes('MEDAN'));
            renderGenericCard('leaderboard-BATAM', 'text-teal-600', d => normalizeZone(d.zone) === 'INTERISLAND' && d.destination.toUpperCase().includes('BATAM'));
        }

        function renderGenericCard(elementId, colorClass, filterFn) {
            const container = document.getElementById(elementId);
            const rawDocs = window.allDocs.filter(filterFn);
            container.innerHTML = '';
            if (rawDocs.length === 0) { container.innerHTML = '<div class="text-sm text-center text-gray-400 py-10 italic">Belum ada data</div>'; return; }
            const vendorStats = {};
            rawDocs.forEach(doc => {
                const name = doc.transporterName.trim();
                if (!vendorStats[name]) { vendorStats[name] = { totalCostIdr: 0, totalCostUsd: 0, count: 0 }; }
                vendorStats[name].totalCostIdr += doc.costPerTonIdr;
                vendorStats[name].totalCostUsd += doc.costPerTonUsd;
                vendorStats[name].count += 1;
            });
            const leaderboard = Object.keys(vendorStats).map(name => {
                const data = vendorStats[name];
                return { name: name, avgIdr: data.totalCostIdr / data.count, avgUsd: data.totalCostUsd / data.count, tripCount: data.count };
            });
            leaderboard.sort((a, b) => a.avgIdr - b.avgIdr);
            leaderboard.slice(0, 5).forEach((vendor, index) => {
                const rank = index + 1;
                let medal = rank === 1 ? 'ðŸ‘‘' : (rank === 2 ? 'ðŸ¥ˆ' : (rank === 3 ? 'ðŸ¥‰' : `<span class="text-gray-400 text-[10px] font-bold">#${rank}</span>`));
                let bgClass = rank === 1 ? 'bg-yellow-50 border-yellow-300 border-l-4 shadow-sm' : 'bg-white border-gray-100 border-b';
                const html = `<div class="rank-item p-3 mb-2 rounded flex items-center justify-between ${bgClass}"><div class="flex items-center gap-3 overflow-hidden w-2/3"><span class="text-xl flex-shrink-0 w-8 text-center">${medal}</span><div class="min-w-0"><div class="font-bold text-gray-800 text-sm truncate leading-tight">${vendor.name}</div><div class="text-[10px] text-gray-400 truncate mt-0.5">Based on ${vendor.tripCount} routes</div></div></div><div class="text-right pl-2 w-1/3"><div class="font-bold ${colorClass} text-sm">${formatIDR(vendor.avgIdr)}</div><div class="font-bold text-green-600 text-sm">${formatUSD(vendor.avgUsd)}</div></div></div>`;
                container.innerHTML += html;
            });
        }
    </script>
</body>
</html>